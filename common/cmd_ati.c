
// atiINIT.cpp : Defines the entry point for the console application.
//
#include <common.h>
#if CONFIG_OCTEON_NAC38


#include <command.h>
#include <asm/processor.h>
//#include <asm/io.h>
#include <pci.h>

#include "rn50.h"
#include "rn50_tiggerb.h"

#define TRUE					1
#define FALSE					0


/*Registers definitions*/
#define	pllCLK_PWRMGT_CNTL			0x0014
#define	pllMCLK_CNTL				0x0012
#define	MC_STATUS					0x0150
#define	MEM_SDRAM_MODE_REG			0x0158
#define	CLOCK_CNTL_INDEX			0x0008
#define	CLOCK_CNTL_DATA 			0x000C
#define ioMM_INDEX					0x0000
#define ioMM_DATA					0x0004	
#define	PALETTE_INDEX				0x00B0
#define	PALETTE_DATA 				0x00B4
#define VIPH_CONTROL				0x0C40
#define SEPROM_CONTROL1				0x01C0


/*Masks definitions*/
#define pllWR_EN				0x00000080
#define pllWR_DIS				0xffffff7f
#define pllINDEX_MASK			0xffffff60
#define pllMASK_BYTE			0xffffff00
#define pllWAIT_MC_BUSY_MASK	0x00010000            // byte 16 = 1
#define pllWAIT_DLL_READY_MASK	0x00080000            // byte 19 = 0
#define MEM_PWRUP_COMPLETE_A	0x01
#define MEM_PWRUP_COMPLETE_B	0x02
#define mask_SDRAM_MODE			0xffff0000
#define mask_b3MEM_RESET		0x6fffffff
#define SET_ALL_SOURCES_TO_PCI	0x00001111
#define CLK_PWRMGT_CNTL24		0x01000000
#define VIPH_ENABLE				((unsigned long) 1 << 21)
#define LINEAR_APERTURE			0x80000000;

//#define OCTEON_PCI_IOSPACE_BASE     0x80011a0400000000ull


static int (*readl) (unsigned int);
static void (*writel) (int, unsigned int);
static int  (*readw)  (unsigned int);		/* Read access function */
static void (*writew) (int, unsigned int);	/* Write access function */

static unsigned int io_base;
static int control=1;
static int cmdINFO=1;

/*Font EGA 8x16*/
char font_ega8x16[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0x82,0x82,0xaa,0x82,0x82,0xc6,0xba,0x82,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xfe,0xfe,0xd6,0xfe,0xfe,0xba,0xc6,0xfe,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x6c,0xee,0xfe,0xfe,0xfe,0xfe,0x7c,0x38,0x10,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x10,0x38,0x7c,0xfe,0x7c,0x38,0x10,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x10,0x38,0x38,0x10,0x6c,0xee,0x6c,0x10,0x38,0x00,0x00,0x00,0x00,
0x00,0x00,0x10,0x38,0x7c,0x7c,0xfe,0xfe,0xfe,0x6c,0x10,0x38,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x18,0x3c,0x3c,0x3c,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
0xff,0xff,0xff,0xff,0xff,0xe7,0xc3,0xc3,0xc3,0xe7,0xff,0xff,0xff,0xff,0xff,0xff,
0x00,0x00,0x00,0x00,0x18,0x3c,0x66,0x66,0x66,0x3c,0x18,0x00,0x00,0x00,0x00,0x00,
0xff,0xff,0xff,0xff,0xe7,0xc3,0x99,0x99,0x99,0xc3,0xe7,0xff,0xff,0xff,0xff,0xff,
0x00,0x00,0x1e,0x0e,0x1e,0x36,0x78,0xcc,0xcc,0xcc,0xcc,0x78,0x00,0x00,0x00,0x00,
0x00,0x00,0x3c,0x66,0x66,0x66,0x3c,0x18,0x7e,0x18,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x1e,0x1a,0x1e,0x18,0x18,0x18,0x18,0x78,0xf8,0x70,0x00,0x00,0x00,0x00,
0x00,0x00,0x3e,0x36,0x3e,0x36,0x36,0x76,0xf6,0x66,0x0e,0x1e,0x0c,0x00,0x00,0x00,
0x00,0x00,0x18,0xdb,0x7e,0x3c,0x66,0x66,0x3c,0x7e,0xdb,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x80,0xe0,0xf0,0xfc,0xfe,0xfc,0xf0,0xe0,0x80,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x02,0x0e,0x3e,0x7e,0xfe,0x7e,0x3e,0x0e,0x02,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x3c,0x7e,0x18,0x18,0x18,0x18,0x7e,0x3c,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x66,0x66,0x00,0x00,0x00,0x00,
0x00,0x00,0x7f,0xdb,0xdb,0xdb,0xdb,0x7b,0x1b,0x1b,0x1b,0x1b,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0x60,0x7c,0xf6,0xde,0x7c,0x0c,0xc6,0xc6,0x7c,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfe,0xfe,0xfe,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x3c,0x7e,0x18,0x18,0x18,0x7e,0x3c,0x18,0x7e,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x3c,0x7e,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7e,0x3c,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0c,0x0e,0xff,0x0e,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x30,0x70,0xfe,0x70,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0xc0,0xc0,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x24,0x66,0xff,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x10,0x38,0x38,0x38,0x7c,0x7c,0xfe,0xfe,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xfe,0xfe,0x7c,0x7c,0x7c,0x38,0x38,0x10,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x3c,0x3c,0x3c,0x3c,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x36,0x36,0x36,0x36,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x6c,0x6c,0x6c,0xfe,0x6c,0x6c,0xfe,0x6c,0x6c,0x6c,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x18,0x7c,0xc6,0xc0,0x78,0x3c,0x06,0xc6,0x7c,0x18,0x18,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x62,0x66,0x0c,0x18,0x30,0x66,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0x38,0x6c,0x38,0x30,0x76,0x7e,0xcc,0xcc,0xcc,0x76,0x00,0x00,0x00,0x00,
0x00,0x0c,0x0c,0x0c,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x0c,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0c,0x00,0x00,0x00,0x00,
0x00,0x00,0x30,0x18,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x18,0x30,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x6c,0x38,0xfe,0x38,0x6c,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x0c,0x0c,0x18,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x02,0x06,0x0c,0x18,0x30,0x60,0xc0,0x80,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0xce,0xde,0xf6,0xe6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7e,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0x06,0x0c,0x18,0x30,0x60,0xc6,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0x06,0x06,0x3c,0x06,0x06,0x06,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x0c,0x1c,0x3c,0x6c,0xcc,0xcc,0xfe,0x0c,0x0c,0x1e,0x00,0x00,0x00,0x00,
0x00,0x00,0xfe,0xc0,0xc0,0xc0,0xfc,0x06,0x06,0x06,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc0,0xc0,0xfc,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0xfe,0xc6,0x06,0x0c,0x18,0x30,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0xc6,0x7c,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0x7e,0x06,0x06,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0c,0x0c,0x00,0x00,0x0c,0x0c,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0c,0x0c,0x00,0x00,0x0c,0x0c,0x0c,0x18,0x00,0x00,0x00,
0x00,0x00,0x00,0x0c,0x18,0x30,0x60,0xc0,0x60,0x30,0x18,0x0c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xfe,0x00,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x60,0x30,0x18,0x0c,0x06,0x0c,0x18,0x30,0x60,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0x0c,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0xc6,0xde,0xde,0xde,0xdc,0xc0,0x7e,0x00,0x00,0x00,0x00,
0x00,0x00,0x38,0x6c,0xc6,0xc6,0xc6,0xfe,0xc6,0xc6,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0xfc,0x66,0x66,0x66,0x7c,0x66,0x66,0x66,0x66,0xfc,0x00,0x00,0x00,0x00,
0x00,0x00,0x3c,0x66,0xc2,0xc0,0xc0,0xc0,0xc0,0xc2,0x66,0x3c,0x00,0x00,0x00,0x00,
0x00,0x00,0xf8,0x6c,0x66,0x66,0x66,0x66,0x66,0x66,0x6c,0xf8,0x00,0x00,0x00,0x00,
0x00,0x00,0xfe,0x66,0x60,0x64,0x7c,0x64,0x60,0x60,0x66,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0xfe,0x66,0x60,0x64,0x7c,0x64,0x60,0x60,0x60,0xf0,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0xc0,0xc0,0xc0,0xce,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0xc6,0xc6,0xc6,0xfe,0xc6,0xc6,0xc6,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0x3c,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0x00,0x3c,0x18,0x18,0x18,0x18,0x18,0x18,0xd8,0xd8,0x70,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0xc6,0xcc,0xd8,0xf0,0xf0,0xd8,0xcc,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0xf0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0xc6,0xee,0xee,0xfe,0xd6,0xd6,0xd6,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0xc6,0xe6,0xe6,0xf6,0xde,0xce,0xce,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0xfc,0x66,0x66,0x66,0x66,0x7c,0x60,0x60,0x60,0xf0,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xd6,0xd6,0x7c,0x06,0x00,0x00,0x00,
0x00,0x00,0xfc,0x66,0x66,0x66,0x7c,0x78,0x6c,0x66,0x66,0xe6,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc0,0xc0,0x70,0x1c,0x06,0x06,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x7e,0x5a,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0x6c,0x38,0x10,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0xc6,0xc6,0xd6,0xd6,0xd6,0xfe,0xee,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0xc6,0xc6,0x6c,0x38,0x38,0x6c,0xc6,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3c,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0x00,0xfe,0xc6,0x86,0x0c,0x18,0x30,0x60,0xc2,0xc6,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x80,0xc0,0x60,0x30,0x18,0x0c,0x06,0x02,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x7c,0x00,0x00,0x00,0x00,
0x00,0x10,0x38,0x6c,0xc6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00,
0x00,0x18,0x18,0x18,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x78,0x0c,0x7c,0xcc,0xcc,0xdc,0x76,0x00,0x00,0x00,0x00,
0x00,0x00,0xe0,0x60,0x60,0x7c,0x66,0x66,0x66,0x66,0x66,0xfc,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x7c,0xc6,0xc0,0xc0,0xc0,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x1c,0x0c,0x0c,0x7c,0xcc,0xcc,0xcc,0xcc,0xcc,0x7e,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x7c,0xc6,0xc6,0xfe,0xc0,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x1c,0x36,0x30,0x30,0xfc,0x30,0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x76,0xce,0xc6,0xc6,0xce,0x76,0x06,0xc6,0x7c,0x00,0x00,
0x00,0x00,0xe0,0x60,0x60,0x7c,0x66,0x66,0x66,0x66,0x66,0xe6,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0x00,0x0c,0x0c,0x00,0x1c,0x0c,0x0c,0x0c,0x0c,0x0c,0xcc,0xcc,0x78,0x00,0x00,
0x00,0x00,0xe0,0x60,0x60,0x66,0x66,0x6c,0x78,0x6c,0x66,0xe6,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x1c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x6c,0xfe,0xd6,0xd6,0xc6,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xdc,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xdc,0x66,0x66,0x66,0x66,0x7c,0x60,0x60,0xf0,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x76,0xcc,0xcc,0xcc,0xcc,0x7c,0x0c,0x0c,0x1e,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xdc,0x66,0x60,0x60,0x60,0x60,0xf0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x7c,0xc6,0xc0,0x7c,0x06,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x30,0x30,0x30,0xfc,0x30,0x30,0x30,0x30,0x36,0x1c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xcc,0xcc,0xcc,0xcc,0xcc,0xcc,0x76,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xc6,0xc6,0xc6,0xc6,0x6c,0x38,0x10,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xc6,0xc6,0xd6,0xd6,0xd6,0xfe,0x6c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xc6,0xc6,0x6c,0x38,0x6c,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xc6,0xc6,0xc6,0xc6,0xce,0x76,0x06,0xc6,0x7c,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xfe,0x86,0x0c,0x18,0x30,0x62,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0x0e,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0e,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x70,0x18,0x18,0x18,0x0e,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00,
0x00,0x00,0x76,0xdc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x10,0x38,0x38,0x6c,0x6c,0xfe,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x3c,0x66,0xc0,0xc0,0xc0,0xc6,0x66,0x3c,0x18,0x0c,0xcc,0x38,0x00,0x00,
0x00,0x00,0xc6,0x00,0x00,0xc6,0xc6,0xc6,0xc6,0xc6,0xce,0x76,0x00,0x00,0x00,0x00,
0x00,0x0c,0x18,0x30,0x00,0x7c,0xc6,0xc6,0xfe,0xc0,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x30,0x78,0xcc,0x00,0x78,0x0c,0x7c,0xcc,0xcc,0xdc,0x76,0x00,0x00,0x00,0x00,
0x00,0x00,0xcc,0x00,0x00,0x78,0x0c,0x7c,0xcc,0xcc,0xdc,0x76,0x00,0x00,0x00,0x00,
0x00,0x60,0x30,0x18,0x00,0x78,0x0c,0x7c,0xcc,0xcc,0xdc,0x76,0x00,0x00,0x00,0x00,
0x00,0x38,0x6c,0x38,0x00,0x78,0x0c,0x7c,0xcc,0xcc,0xdc,0x76,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x7c,0xc6,0xc0,0xc0,0xc6,0x7c,0x18,0x0c,0x6c,0x38,0x00,0x00,
0x00,0x30,0x78,0xcc,0x00,0x7c,0xc6,0xc6,0xfe,0xc0,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0xcc,0x00,0x00,0x7c,0xc6,0xc6,0xfe,0xc0,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x30,0x18,0x0c,0x00,0x7c,0xc6,0xc6,0xfe,0xc0,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x66,0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0x18,0x3c,0x66,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0xc6,0x00,0x38,0x6c,0xc6,0xc6,0xc6,0xfe,0xc6,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x38,0x6c,0x38,0x00,0x38,0x6c,0xc6,0xc6,0xfe,0xc6,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x0c,0x18,0x30,0x00,0xfe,0x60,0x60,0x7c,0x60,0x60,0x60,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x66,0xdb,0x1b,0x7f,0xd8,0xd8,0xdf,0x76,0x00,0x00,0x00,0x00,
0x00,0x00,0x7e,0xd8,0xd8,0xd8,0xd8,0xfe,0xd8,0xd8,0xd8,0xde,0x00,0x00,0x00,0x00,
0x00,0x30,0x78,0xcc,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0xc6,0x00,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x30,0x18,0x0c,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x30,0x78,0xcc,0x00,0xc6,0xc6,0xc6,0xc6,0xc6,0xce,0x76,0x00,0x00,0x00,0x00,
0x00,0x60,0x30,0x18,0x00,0xc6,0xc6,0xc6,0xc6,0xc6,0xce,0x76,0x00,0x00,0x00,0x00,
0x00,0x18,0x00,0x3c,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0xc6,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0xc6,0x00,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x18,0x18,0x7c,0xc6,0xc0,0xc0,0xc6,0x7c,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x38,0x6c,0x60,0x60,0xf0,0x60,0x60,0x60,0x66,0xf6,0x6c,0x00,0x00,0x00,0x00,
0x00,0x66,0x66,0x66,0x66,0x3c,0x18,0x7e,0x18,0x3c,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x3e,0x63,0x63,0x30,0x1c,0x06,0x63,0x63,0x3e,0x00,0x1c,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x3e,0x63,0x38,0x0e,0x63,0x3e,0x00,0x1c,0x00,0x00,0x00,
0x00,0x0c,0x18,0x30,0x00,0x78,0x0c,0x7c,0xcc,0xcc,0xdc,0x76,0x00,0x00,0x00,0x00,
0x00,0x0c,0x18,0x30,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3c,0x00,0x00,0x00,0x00,
0x00,0x0c,0x18,0x30,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x18,0x30,0x60,0x00,0xcc,0xcc,0xcc,0xcc,0xcc,0xdc,0x76,0x00,0x00,0x00,0x00,
0x00,0x00,0x76,0xdc,0x00,0xbc,0x66,0x66,0x66,0x66,0x66,0xe6,0x00,0x00,0x00,0x00,
0x00,0x76,0xdc,0x00,0xc6,0xc6,0xe6,0xf6,0xde,0xce,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x21,0x1e,0x00,0x1e,0x33,0x60,0x60,0x67,0x63,0x33,0x1d,0x00,0x00,0x00,0x00,
0x00,0x42,0x3c,0x00,0x3b,0x66,0x66,0x66,0x3e,0x06,0x66,0x3c,0x00,0x00,0x00,0x00,
0x00,0x00,0x30,0x30,0x00,0x30,0x30,0x30,0x60,0xc6,0xc6,0x7c,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7e,0x60,0x60,0x60,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7e,0x06,0x06,0x06,0x00,0x00,0x00,0x00,0x00,
0x00,0x60,0x60,0x62,0x66,0x6c,0x18,0x30,0x60,0xdc,0x36,0x0c,0x18,0x3e,0x00,0x00,
0x00,0x60,0x60,0x62,0x66,0x6c,0x18,0x36,0x6e,0xde,0x36,0x7e,0x06,0x06,0x00,0x00,
0x00,0x00,0x18,0x18,0x00,0x18,0x18,0x3c,0x3c,0x3c,0x3c,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x36,0x6c,0xd8,0x6c,0x36,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xd8,0x6c,0x36,0x6c,0xd8,0x00,0x00,0x00,0x00,0x00,0x00,
0x11,0x44,0x11,0x44,0x11,0x44,0x11,0x44,0x11,0x44,0x11,0x44,0x11,0x44,0x11,0x44,
0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55,0xaa,0x55,
0xdd,0x77,0xdd,0x77,0xdd,0x77,0xdd,0x77,0xdd,0x77,0xdd,0x77,0xdd,0x77,0xdd,0x77,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0xf8,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0xf8,0x18,0xf8,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x36,0x36,0x36,0x36,0x36,0x36,0x36,0xf6,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xfe,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x00,0x00,0x00,0x00,0x00,0xf8,0x18,0xf8,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x36,0x36,0x36,0x36,0x36,0xf6,0x06,0xf6,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x00,0x00,0x00,0x00,0x00,0xfe,0x06,0xf6,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x36,0x36,0x36,0x36,0x36,0xf6,0x06,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x36,0x36,0x36,0x36,0x36,0x36,0x36,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x18,0x18,0x18,0x18,0x18,0xf8,0x18,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf8,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x1f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x1f,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0xff,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0x1f,0x18,0x1f,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x37,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x36,0x36,0x36,0x36,0x36,0x37,0x30,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x3f,0x30,0x37,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x36,0x36,0x36,0x36,0x36,0xf7,0x00,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xff,0x00,0xf7,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x36,0x36,0x36,0x36,0x36,0x37,0x30,0x37,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x00,0x00,0x00,0x00,0x00,0xff,0x00,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x36,0x36,0x36,0x36,0x36,0xf7,0x00,0xf7,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x18,0x18,0x18,0x18,0x18,0xff,0x00,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x36,0x36,0x36,0x36,0x36,0x36,0x36,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xff,0x00,0xff,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x18,0x18,0x18,0x18,0x18,0x1f,0x18,0x1f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x1f,0x18,0x1f,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x36,0x36,0x36,0x36,0x36,0x36,0x36,0xff,0x36,0x36,0x36,0x36,0x36,0x36,0x36,0x36,
0x18,0x18,0x18,0x18,0x18,0xff,0x18,0xff,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1f,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,
0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,
0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x76,0xdc,0xd8,0xd8,0xd8,0xd8,0xdc,0x76,0x00,0x00,0x00,0x00,
0x00,0x00,0x78,0xcc,0xcc,0xd8,0xfc,0xc6,0xc6,0xc6,0xc6,0xcc,0x00,0x00,0x00,0x00,
0x00,0x00,0xfe,0x66,0x62,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xfe,0x6c,0x6c,0x6c,0x6c,0x6c,0x6c,0x00,0x00,0x00,0x00,
0x00,0x00,0xfe,0xc6,0x62,0x30,0x18,0x18,0x30,0x62,0xc6,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x7e,0xd8,0xcc,0xcc,0xcc,0xd8,0x70,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x7c,0x60,0xc0,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x76,0xdc,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0xfe,0x38,0x38,0x6c,0xc6,0xc6,0x6c,0x38,0x38,0xfe,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x38,0x6c,0xc6,0xc6,0xfe,0xc6,0xc6,0x6c,0x38,0x00,0x00,0x00,0x00,
0x00,0x00,0x38,0x6c,0xc6,0xc6,0xc6,0xc6,0x6c,0x6c,0x6c,0xee,0x00,0x00,0x00,0x00,
0x00,0x00,0x3e,0x60,0x60,0x3c,0x66,0xc6,0xc6,0xc6,0xcc,0x78,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x7e,0xdb,0xdb,0xdb,0x7e,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x02,0x06,0x7c,0xce,0xde,0xf6,0xf6,0x7c,0x60,0xc0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x1c,0x30,0x60,0x60,0x7c,0x60,0x60,0x30,0x1c,0x00,0x00,0x00,0x00,
0x00,0x00,0x7c,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0xc6,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xfe,0x00,0x00,0xfe,0x00,0x00,0xfe,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00,0x7e,0x00,0x00,0x00,0x00,
0x00,0x00,0x30,0x18,0x0c,0x06,0x0c,0x18,0x30,0x00,0x00,0x7e,0x00,0x00,0x00,0x00,
0x00,0x00,0x0c,0x18,0x30,0x60,0x30,0x18,0x0c,0x00,0x00,0x7e,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x0c,0x1e,0x1a,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x58,0x78,0x30,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x7e,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x76,0xdc,0x00,0x76,0xdc,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x78,0xcc,0xcc,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x1f,0x18,0x18,0x18,0x18,0x18,0xd8,0xd8,0x78,0x38,0x18,0x00,0x00,0x00,
0x00,0x00,0xd8,0x6c,0x6c,0x6c,0x6c,0x6c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x70,0xd8,0x18,0x30,0x60,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x7e,0x7e,0x7e,0x7e,0x7e,0x7e,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
/**********************************************************************************************/

int abs(int nu)
{
   return (nu < 0 )? nu : -nu;
}

/*static uint32_t ld_le32(volatile uint32_t *ptr)
{
    uint32_t tmp, tmp1;    
  
    tmp1 = (*ptr >> 16) & 0xff;
    tmp = tmp1<<24;

    tmp1 = (*ptr >> 24) & 0xff;
    tmp = tmp | (tmp1<<16);

    tmp1 = (*ptr >> 0) & 0xff;
    tmp = tmp | (tmp1<<8);

    tmp1 = (*ptr >> 8) & 0xff;
    tmp = tmp | (tmp1<<0);
    
    
    return(tmp);

}*/

/**********************************************************************************************/
/*IO Access functions*/
/**********************************************************************************************/
void out_io_reg(unsigned int index, unsigned int data)
{
//printf("out_io_reg index=%x, data=%x\n", index, data);
//data=le32_to_cpu(data);
	writel(data, io_base + index);
}

unsigned int in_io_reg(unsigned int index)
{
	return readl(io_base + index);
}


void out_index_reg(unsigned int index, unsigned long data)
{
//  printf("out_index_reg index=%x, data=%x\n", index, data);
	writel(index, io_base + ioMM_INDEX);
//data=le32_to_cpu(data);
	writel(data, io_base + ioMM_DATA);
udelay(1);
if ( data != ((unsigned long)readl(io_base + ioMM_DATA)) )
   printf("***Verify Error W:%x R:%x", data, readl(io_base + ioMM_DATA));
else
   printf("***Verify O.K.", data, readl(io_base + ioMM_DATA));
}

unsigned int in_index_reg(unsigned int index)
{
	writel(index, io_base + ioMM_INDEX);
	return readl(io_base + ioMM_DATA);
}

void mask_index_reg(unsigned int index, unsigned int andmask, unsigned int ormask)
{
  unsigned int temp;

  writel(index, io_base + ioMM_INDEX);
  temp = readl(io_base + ioMM_DATA);
  temp = (temp & andmask) | ormask;
  writel(temp, io_base + ioMM_DATA);
}

void mask_io_reg(unsigned int index, unsigned int andmask, unsigned int ormask)
{
	unsigned int temp;

	temp = readl(io_base + index);
	temp&=andmask;
	temp|=ormask;
	writel(temp, io_base + index);
}


/**********************************************************************************************/
/*PLL registers through IO Access functions*/
/**********************************************************************************************/
void prog_pll_dword(unsigned short index, unsigned int data)
{
	writel((index & 0x3f) | pllWR_EN, io_base + CLOCK_CNTL_INDEX);
//data=le32_to_cpu(data);
	writel(data, io_base + CLOCK_CNTL_DATA);
	writel(0, io_base + CLOCK_CNTL_INDEX);
}

unsigned long pll_read(unsigned int index)
{
	writel(index, io_base + CLOCK_CNTL_INDEX);
	return (readl(io_base + CLOCK_CNTL_DATA));
}



//Parameter "offset" is an offset of mask inside of dword
void mask_pll_byte(unsigned short index, unsigned char offset, unsigned char andmask, unsigned char ormask)
{
	unsigned int and_mask=(((unsigned int)andmask) << (offset * 8)) | ~((unsigned int)0xff << (offset*8));
	unsigned int or_mask=(unsigned int)ormask << (offset * 8);

	writel((index & 0x3f) | pllWR_EN, io_base + CLOCK_CNTL_INDEX);
	mask_io_reg(CLOCK_CNTL_DATA,and_mask,or_mask);
	writel( 0, io_base +  + CLOCK_CNTL_INDEX);

}



///////////////////////////////////////////////////////////////////////////////


/*ASIC init table records sizes*/
#define INIT_TABLE_COMMAND_SIZE		2
#define INIT_TABLE_DATA_SIZE		4
#define INIT_TABLE_DELAY_SIZE		2
#define INIT_TABLE_SCOMMAND_SIZE	2


//*********************************************************************************
//Function gets parameters from a given ASIC Init table and does the following operations
//depends on parameter's flag :
//programming registers, masking registers, delaying, waiting for some registers status
//or if command INFO is set it's printing on a screen what it's currently doing
//*********************************************************************************
int load_init_block(unsigned int *init_block, const char* comment)
{

	unsigned int i;
	unsigned long ormask, andmask;
	unsigned short flag,index,command;

	if (init_block == NULL){
		printf("\nLoadInitBlock : table does not exist!!!");
		return (FALSE);
	}

	if (control & cmdINFO) printf("\n\n*************** %s ******************** ",comment);
	if (control & cmdINFO) printf("\nTable revision : 0x%02x\n",*(init_block-1));

	while(*init_block){
		//parsing a service word:
		flag= (unsigned short)*init_block & 0xe000;  //taking highest 3 bits
		index= (unsigned short)*init_block & 0x1fff; //the rest of the word can be index
		command= (unsigned short)*init_block & 0xff; //scpecial command takes 1 byte
	//if (control & cmdINFO) printf("***init_block=%08lx flag=%x, index=%x, command=%x\n", *init_block, flag, index, command);

		init_block++;	
		
		switch (flag){
		case 0x0000:  // writing data to Index (Memory) Register; 4 bytes
			if (control & cmdINFO) printf("\nIndex register 0x%04x <- 0x%08lx",index, *(unsigned long*) init_block);
			out_index_reg(index,*init_block);
			init_block++;					
			break;
		case 0x2000:	// writing data to IO Register; 4 bytes
			if (control & cmdINFO) printf("\nIO register 0x%02x <- 0x%08lx",index, *(unsigned long*) init_block);
			out_io_reg(index,*init_block);
			init_block++;
			break;
		case 0x4000:  // masking Index (Memory) Register; both "and" and "or" masks are 4 bytes long			
			andmask= *init_block;			
			init_block++;
			ormask = *init_block;
			init_block++;
			if (control & cmdINFO) printf("\nIndex register 0x%04x AND 0x%08lx OR 0x%08lx",index, andmask, ormask);
			mask_index_reg(index,andmask,ormask);			
			break;
		case 0x6000:	// masking IO registers; 8 bytes
			andmask=*init_block;
			init_block++;
			ormask=*init_block;
			init_block++;
			if (control & cmdINFO) printf("\nIO register 0x%04x AND 0x%08lx OR 0x%08lx",index, andmask, ormask);
			mask_io_reg(index,andmask,ormask);
			break;
		case 0x8000:	// Delay mks; 2 bytes
			if (control & cmdINFO) printf("\nDelay %d mks",(unsigned short) *init_block);
			udelay((unsigned short)*init_block);
			init_block++;
			break;
		case 0xa000:  // Special command; 2 bytes
			if (control & cmdINFO) printf("\nSpecial command [0x%02x] - ",command);
			switch (command){
			case 0x0003: 
				if (control & cmdINFO) printf("wait CLK_PWRMGT_CNTL for WAIT_MC_BUSY_MASK bit set to 0");
				for (i=0; i < *init_block; i++)
					if ((pll_read(pllCLK_PWRMGT_CNTL) & pllWAIT_MC_BUSY_MASK) == 0) break;
				break;
			case 0x0008:
				if (control & cmdINFO) printf("check MC_STATUS for MEM_PWRUP_COMPLETE");
				for (i=0;i<*init_block;i++)
					if (((unsigned char)in_index_reg(MC_STATUS) & 3) == MEM_PWRUP_COMPLETE_A+MEM_PWRUP_COMPLETE_B) break;
				break;
			}
			init_block++;
			break;
	  }
  }
	  return (TRUE);
}
/*Tables commands definitions*/
#define PLL_WAIT					0x80
#define PLL_PROGRAM_DWORD			0x00
#define PLL_MASK_BYTE				0x40
#define PLL_FLAG_BITS				0xc0
#define PLL_INDEX_BITS				0x3f
#define PLL_DELAY_150MKS			1
#define PLL_DELAY_5MS				2
#define WAIT_MC_BUSY_MASK			3
#define WAIT_DLL_READY_MASK			4
#define CHECK_SET_CLK_PWRMGT_CNTL24	5

//*********************************************************************************
//Function gets parameters from a given PLL Init table and does the following operations
//depends on parameter's flag :
//wait (150mks,5ms or till some bit is set), programming registers, masking registers
//or if command INFO is set it's printing on a screen what it's currently doing
//*********************************************************************************
int load_pll_block(unsigned int *init_block, const char* comment)
{

	unsigned long pwmgmtcntl;
	unsigned char offset;
	unsigned char andmask;
	unsigned char ormask;
	unsigned char index;
	int i;
	if (init_block == NULL){
		printf("\nLoadPLLBlock : table does not exist!!!");
		return (FALSE);
	}
	
if (control & cmdINFO) printf("\n\n*************** %s ******************** ",comment);
  if (control & cmdINFO) printf("\nTable revision : 0x%02x\n",*(init_block-1));
	while(*init_block){
		index = (unsigned char)*init_block++;
		switch (index & PLL_FLAG_BITS){
		case PLL_WAIT:						//This operation takes 1 byte from a table
		    switch (index & PLL_INDEX_BITS){
			case PLL_DELAY_150MKS:
				if (control & cmdINFO) printf("\nDelay 150 mks");
				udelay(150);
				break;
			case PLL_DELAY_5MS:
				if (control & cmdINFO) printf("\nDelay 5 ms");
				udelay(5*1000);
				break;
			case WAIT_MC_BUSY_MASK:
				if (control & cmdINFO) printf("\nwait CLK_PWRMGT_CNTL for WAIT_MC_BUSY_MASK bit set to 0");
				for (i=0; i<10000; i++)
					if ((pll_read(pllCLK_PWRMGT_CNTL) & pllWAIT_MC_BUSY_MASK) == 0) break;
				break;
			case WAIT_DLL_READY_MASK:
				if (control & cmdINFO) printf("\nwait CLK_PWRMGT_CNTL for WAIT_DLL_READY_MASK bit set to 1");
				for (i=0; i<10000; i++)
					if ((pll_read(pllCLK_PWRMGT_CNTL) & pllWAIT_DLL_READY_MASK) != 0) break;
				break;
			case CHECK_SET_CLK_PWRMGT_CNTL24:
				if (control & cmdINFO) printf("\ncheck PWRMGT_CNTL for bit 24 and clear it");
				if (((pwmgmtcntl=pll_read(pllCLK_PWRMGT_CNTL)) & CLK_PWRMGT_CNTL24) != 0){
					prog_pll_dword(pllMCLK_CNTL, (pll_read(pllMCLK_CNTL) & 0xFFFF0000) | SET_ALL_SOURCES_TO_PCI);
					udelay(10000);
					prog_pll_dword(pllCLK_PWRMGT_CNTL,pwmgmtcntl & ~CLK_PWRMGT_CNTL24);
					udelay(10000);
				}
				break;
			}
			break;
		case PLL_MASK_BYTE:			// This operation takes 3 bytes from a table
			offset=(unsigned char)*init_block++;   // offset of byte inside a dword
			andmask=(unsigned char)*init_block++;  // and mask
			ormask=(unsigned char)*init_block++;   // or mask
			if (control & cmdINFO) printf("\nPLL byte 0x%04x, bits %d-%d AND 0x%02x OR 0x%02x",index,offset*8,offset*8+8,andmask,ormask);
			mask_pll_byte(index,offset,andmask,ormask);
			break;
		case PLL_PROGRAM_DWORD:		// This operation takes 4 bytes from a table
			if (control & cmdINFO) printf("\nPLL DWORD 0x%04x <- 0x%08lx",index, *(unsigned long*)init_block );
			prog_pll_dword(index,*init_block);
			init_block++;
			break;
		}
		  
	}
	  return (TRUE);
}



//*********************************************************************************
//Function gets parameters from a given Memory reset table, runs ASIC init tables 3 and 4
//and does the following operations depends on parameter's flag :
//wait for MEM_PWRUP_COMPLETE and masking registers
//or if command INFO is set it's printing on a screen what it's currently doing
//*********************************************************************************

int reset_sdram(unsigned short *reset_block, const char * comment)
{
	
	int i;
	unsigned char index;

	if (reset_block == NULL){
		printf("\nReset_SDRAM : table does not exist!!!");
		return (FALSE);
	}

  if (control & cmdINFO) printf("\n\n*************** %s ******************** ",comment);
  if (control & cmdINFO) printf("\nTable revision : 0x%02x\n",*(reset_block-1));
	while(*reset_block != 0xff){
		index=(unsigned char)*reset_block++;
		if (index == 0x0f){
			if (control & cmdINFO) printf("\ncheck MC_STATUS for MEM_PWRUP_COMPLETE");
			for (i=0;i<20000;i++)
				if (((unsigned char)in_index_reg(MC_STATUS) & 3) == MEM_PWRUP_COMPLETE_A+MEM_PWRUP_COMPLETE_B) break;
				
		}else{
			if (control & cmdINFO) printf("\nIndex register 0x%04x AND 0x%08lx OR 0x%08x",MEM_SDRAM_MODE_REG, mask_SDRAM_MODE, *(unsigned short*)reset_block);			
			mask_index_reg(MEM_SDRAM_MODE_REG, mask_SDRAM_MODE, *reset_block);
			reset_block++;
			if (control & cmdINFO) printf("\nIndex register 0x%04x AND 0x%08lx OR 0x%08lx",MEM_SDRAM_MODE_REG, mask_b3MEM_RESET, (unsigned long)index << 24);			
			mask_index_reg(MEM_SDRAM_MODE_REG, mask_b3MEM_RESET, (unsigned int)index << 24);
		}
	}
	
	return (TRUE);
}





//*********************************************************************************
//Programming palette registers

void init_dac(void)         //for mode 1204 16bpp only
{
	int i;
	unsigned long pal=0;
	writel(io_base + PALETTE_INDEX,0);
	for (i = 0; i < 0x100; i++)	{
		writel(pal, io_base + PALETTE_DATA);
		pal+=0x010101;
	}
}

/*Constants to validate table pointer*/
#define MAX_REVISION					0x10
#define MIN_TABLE_POINTER_ALLOWED		0x60
#define SINGLE_TABLE_REVISION			0x09

/**********************************************************************************************/
/*Definitions for displaying of test pattern*/

#define MAX_X_RESOLUTION	640
#define MAX_Y_RESOLUTION	480
#define TEXT_COLOR1			0x07ff
#define BORDER_COLOR		0xffff
#define BLUE_COLOR			0x001f
#define GREEN_COLOR			0x07E0
#define RED_COLOR			0xf800
#define TEXT_COLOR2			0xffe0

/**********************************************************************************************/
/*The following fuctions are used to display a pattern after video mode's initialized */
/**********************************************************************************************/
/*Function to put a pixel on a screen*/
void outpix(unsigned int x, unsigned int y, unsigned int color)
{
	unsigned short port = io_base; //port 0 - MM_INDEX
	unsigned int position = y*(unsigned int)640;	//calulate pixel position
	position += x;
	position <<= 1;									// for 16bpp mode
	position |= LINEAR_APERTURE;					// choosing video memory
	writel(position, port);						// write index
	port=port+4+((x << 1) & 3);						// data register low or high part depends on position parity
	writel(color, port);							// write data
}



void line(int Ax, int Ay, int Bx, int By, unsigned long Color)
{
	int dX = abs(Bx-Ax);							// store the change in X and Y of the line endpoints
	int dY = abs(By-Ay);
	
	int Xincr, Yincr;
	if (Ax > Bx) { Xincr=-1; } else { Xincr=1; }	// which direction in X?
	if (Ay > By) { Yincr=-1; } else { Yincr=1; }	// which direction in Y?
	
	if (dX >= dY)									// if X is the independent variable
	{           
		int dPr 	= dY<<1;						// amount to increment decision if right is chosen (always)
		int dPru 	= dPr - (dX<<1);				// amount to increment decision if up is chosen
		int P 		= dPr - dX;						// decision variable start value

		for (; dX>=0; dX--)							// process each point in the line one at a time (just use dX)
		{
			outpix(Ax, Ay, Color);					// plot the pixel
			if (P > 0)								// is the pixel going right AND up?
			{ 
				Ax+=Xincr;							// increment independent variable
				Ay+=Yincr;							// increment dependent variable
				P+=dPru;							// increment decision (for up)
			}
			else									// is the pixel just going right?
			{
				Ax+=Xincr;							// increment independent variable
				P+=dPr;								// increment decision (for right)
			}
		}		
	}
	else											// if Y is the independent variable
	{
		int dPr 	= dX<<1;						// amount to increment decision if right is chosen (always)
		int dPru 	= dPr - (dY<<1);				// amount to increment decision if up is chosen
		int P 		= dPr - dY;						// decision variable start value

		for (; dY>=0; dY--)							// process each point in the line one at a time (just use dY)
		{
			outpix(Ax, Ay, Color);					// plot the pixel
			if (P > 0)								// is the pixel going up AND right?
			{ 
				Ax+=Xincr;							// increment dependent variable
				Ay+=Yincr;							// increment independent variable
				P+=dPru;							// increment decision (for up)
			}
			else									// is the pixel just going up?
			{
				Ay+=Yincr;							// increment independent variable
				P+=dPr;								// increment decision (for right)
			}
		}		
	}		
}




void drawbar(int Ax, int Ay, int Bx, int By, unsigned int Color)
{
	line(Ax,Ay,Bx,Ay,Color);
	line(Ax,By,Bx,By,Color);
	line(Ax,Ay,Ax,By,Color);
	line(Bx,Ay,Bx,By,Color);
}

/*Just call neccessary number of lines... to make the code easier*/
void fillbar(int Ax, int Ay, int Bx, int By, unsigned int Color)
{
	while (Ay < By)	{
		line(Ax,Ay,Bx,Ay,Color);Ay++;
	}
}


void outchar (char ch, int x, int y, unsigned long color)
{
	int i,j;

	for (i=0; i < 16; i++){				//height=16
	    for (j=0;j<8; j++)				//width=8
		if (font_ega8x16[(int)ch*16+i] & (0x80 >> j))	//taking character from table and put current mask
		    outpix(x+j,y+i,color);		//put pixel if not zero
	}

}






void outtext (int x, int y, unsigned long color, char *text)
{
	int xc,yc;

	xc = x*8;				//width=8
	yc = y*16;				//height=16
	while (*text){				//zero-terminated string
		outchar (*text++,xc,yc,color);
		xc += 8;
	}
}

int memPresentDetect(void)
{
   return 0;		// success
}

void MemorySizing(void)
{
   unsigned long val;  
   // Save and clear Bit 27 of MC_DEBUG
   val = in_index_reg(_mmMC_DEBUG);
   mask_index_reg(_mmMC_DEBUG, 0xf7ffffff, 0x00);

   if ( memPresentDetect() )
   {
      // channel A found
   }
   else
   {
      //channel A not found, set mem_addr_map_A value to zero
      mask_index_reg(_mmMEM_CNTL, 0xffffff00, 0x00);

   }
   

}


#define PCI_ATIRN50_VENDOR_ID 0x1002
#define PCI_DEVICE_ID_ATIRN50 0x515e


int do_ati_init(cmd_tbl_t *cmdtp, int flag, int argc, char *argv[])
{
/*********************************************/
/*	unsigned long rage_regs_1_table[]        */
/*	unsigned long pll_init_table[]           */
/*	unsigned long rage_regs_2_table[]        */
/*	unsigned long rage_regs_4_table[]        */
/*	unsigned short mem_reset_table[]         */
/*	unsigned long rage_regs_3_table[]        */
/*	unsigned long dyn_clock_table[]          */
/*	unsigned long umod640pll[]               */
/*	unsigned long umod640reg[]               */
/*********************************************/

	int ret;
	char text_buffer[80];//buffer to store char lines used for graphics output
	u16 temp;

	pci_dev_t dev;

		
	dev = pci_find_device(PCI_ATIRN50_VENDOR_ID, PCI_DEVICE_ID_ATIRN50, 0);
	printf("dev = 0x%x\n", dev);

	
	/**************************************************************/
	/* those code used to initilaze the io_bar should not be here */
	/* please put it in octeon_pci.c if the function is be test ok*/
	/* RichardXY_Huang@asus.com.cn                                */
	/**************************************************************/
	
	
	/************************************************************/	

	//enable pci device.
	pci_read_config_word(dev, PCI_COMMAND, &temp);
	printf("ati pci command reg 0x%x\n", temp);
	pci_write_config_dword(dev, PCI_COMMAND, temp | PCI_COMMAND_IO | PCI_COMMAND_MASTER | PCI_COMMAND_MEMORY);

	
	pci_read_config_dword(dev, PCI_BASE_ADDRESS_1, &io_base);
	printf("base = 0x%x\n", io_base);

	io_base = io_base & 0xfffc;
	
//	io_base = pci_io_to_phys(dev, io_base);
//	printf("base = 0x%x\n", io_base);
		
	readl  = get_pci_io_readl_func  (dev, io_base);
	writel = get_pci_io_writel_func (dev, io_base);
	readw  = get_pci_io_readw_func  (dev, io_base);
	writew = get_pci_io_writew_func (dev, io_base);

	io_base = pci_io_to_phys(dev, io_base);
	printf("base = 0x%x\n", io_base);

//	io_base = pci_mem_to_phys(dev, io_base);


	// starting initialization sequence
	// running ASIC init table #1 in any case
	// it can be first table of sequence or the only table if BIOS revision = 9
	
	if (rage_regs_1_table !=NULL) ret = load_init_block(rage_regs_1_table, "ASIC INIT TABLE #1"); 

	if (rom_hdr_rev < SINGLE_TABLE_REVISION){
		// continue if older BIOS
		if (pll_init_table !=NULL) ret &= load_pll_block(pll_init_table, "PLL INIT TABLE");
		if (rage_regs_2_table !=NULL) ret &= load_init_block(rage_regs_2_table, "ASIC INIT TABLE #2");
		if (rage_regs_4_table != NULL)  ret &= load_init_block(rage_regs_4_table, "ASIC INIT TABLE #4");
		if (mem_reset_table != NULL) ret &= reset_sdram(mem_reset_table, "MEMORY RESET TABLE");
		if (rage_regs_3_table != NULL)  ret &= load_init_block(rage_regs_3_table, "ASIC INIT TABLE #3");
		if (dyn_clock_table != NULL) ret &= load_pll_block(dyn_clock_table, "DYNAMIC CLOCK ENABLE TABLE");
	}
	// Initialization of graphics mode
	ret &= load_pll_block(umod640pll, "Accelerator mode 640x480x16bpp PLL table");
	ret &= load_init_block(umod640reg, "Accelerator mode 640x480x16bpp PLL table");
	
/****************************************************************************************/
/****************************************************************************************/




	init_dac();	// generating palette, for mode 1204 16bpp only
////////////////////////////TEST PATTERN////////////////////////////////////////////
	drawbar(0, 0, MAX_X_RESOLUTION - 1, MAX_Y_RESOLUTION - 1, BORDER_COLOR);
	fillbar(1, 1, MAX_X_RESOLUTION - 2, MAX_Y_RESOLUTION / 3, RED_COLOR);
	fillbar(1, MAX_Y_RESOLUTION / 3, MAX_X_RESOLUTION - 2, MAX_Y_RESOLUTION / 3 * 2, GREEN_COLOR);
	fillbar(1, MAX_Y_RESOLUTION / 3 * 2, MAX_X_RESOLUTION - 2, MAX_Y_RESOLUTION - 2, BLUE_COLOR);
	line(0, 0, MAX_X_RESOLUTION - 1, MAX_Y_RESOLUTION - 1, BORDER_COLOR);
	sprintf(text_buffer, "Mode %dx%dx16bpp",MAX_X_RESOLUTION,MAX_Y_RESOLUTION);
	outtext(30, 1, TEXT_COLOR1, text_buffer);
	sprintf(text_buffer, "Chip ID          RN50");
	outtext(2, 21, TEXT_COLOR2, text_buffer);
	sprintf(text_buffer, "IO Base Address  %04Xh", io_base);
	outtext(2, 22, TEXT_COLOR2, text_buffer);
//	sprintf(text_buffer, "Aperture Address %08lXh",defaultdev->memory_base);
//	outtext(2, 23, TEXT_COLOR2, text_buffer);

	/*
	//if it's primary card we are calling a video bios to go back to VGA mode 3
	if ((defaultdev->config & MEM_IO_ENABLE)!=0){
	_asm call dword ptr c0000003
	}
	*/
	return 0;
}





U_BOOT_CMD(
	ati_init, 5, 1, do_ati_init,
	"find the ati RN50 a\n",
	"just test\n"
);



#endif
